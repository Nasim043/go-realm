## ЁЯза **Go Concurrency Day 3 тАФ WaitGroups & Mutex (Synchronization)**

## ЁЯОп рж▓ржХрзНрж╖рзНржп

ржЖржЬ рждрзБржорж┐ рж╢рж┐ржЦржмрзЗ ржХрзАржнрж╛ржмрзЗ ржПржХрж╛ржзрж┐ржХ goroutine ржПржХрж╕рж╛ржерзЗ ржЪрж▓рж▓рзЗржУ ржкрзНрж░рзЛржЧрзНрж░рж╛ржо **safe ржПржмржВ predictable** рж░рж╛ржЦрж╛ ржпрж╛рзЯред
ржорзВрж▓ржд ржЖржорж░рж╛ рж╢рж┐ржЦржмрзЛ:

* WaitGroup
* Mutex / RWMutex
* Race Condition
* Race Detector (`go run -race`)
* Channels ржмржирж╛ржо Mutex ржмрзНржпржмрж╣рж╛рж░ ржХржмрзЗ ржЙржкржпрзБржХрзНржд

---
### ржХрзЗржи synchronization ржжрж░ржХрж╛рж░?

Go-рждрзЗ goroutine ржЧрзБрж▓рзЛ ржПржХржЗ рж╕рж╛ржерзЗ ржЪрж▓рждрзЗ ржкрж╛рж░рзЗред

ржХрж┐ржирзНрждрзБ ржпржжрж┐ рждрж╛рж░рж╛ shared data ржмрзНржпржмрж╣рж╛рж░ ржХрж░рзЗ, рждржЦржи ржнрзБрж▓ ржорж╛ржи, ржЕрж╕рж╛ржоржЮрзНржЬрж╕рзНржпржкрзВрж░рзНржг ржЕржмрж╕рзНржерж╛, ржЕржержмрж╛ race condition ржШржЯрждрзЗ ржкрж╛рж░рзЗред

### 1) WaitGroup ржХрзА?

`sync.WaitGroup` ржмрзНржпржмрж╣рж╛рж░ ржХрж░рж╛ рж╣рзЯ ржПржХрж╛ржзрж┐ржХ goroutine рж╢рзЗрж╖ рж╣ржУрзЯрж╛ ржкрж░рзНржпржирзНржд **main function** ржХрзЗ ржЕржкрзЗржХрзНрж╖рж╛ ржХрж░рж╛ржирзЛрж░ ржЬржирзНржпред

`WaitGroup` ржжрж┐ржпрж╝рзЗ ржЖржорж░рж╛ ржмрж▓рждрзЗ ржкрж╛рж░рж┐:

>тАЬржПржЗ X рж╕ржВржЦрзНржпржХ goroutine рж╢рзЗрж╖ ржирж╛ рж╣ржУржпрж╝рж╛ ржкрж░рзНржпржирзНржд main() ржмржирзНржз рж╣ржмрзЗ ржирж╛редтАЭ

### ЁЯФ╣ ржорзВрж▓ рждрж┐ржиржЯрж┐ ржорзЗржержб

| ржорзЗржержб     | ржХрж╛ржЬ                                               |
| -------- | ------------------------------------------------- |
| `Add(n)` | n ржЯрж┐ goroutine рж╢рзБрж░рзБ рж╣ржмрзЗ рждрж╛ WaitGroup-ржХрзЗ ржЬрж╛ржирж╛ржирзЛ                     |
| `Done()` | ржПржХржЯрж┐ goroutine ржХрж╛ржЬ рж╢рзЗрж╖ рждрж╛ WaitGroup-ржХрзЗ ржЬрж╛ржирж╛ржирзЛ                  |
| `Wait()` | рж╕ржм Done() ржирж╛ рж╣ржУржпрж╝рж╛ ржкрж░рзНржпржирзНржд main() ржЕржкрзЗржХрзНрж╖рж╛ ржХрж░рзЗ |

### ЁЯФ╕ ржЙржжрж╛рж╣рж░ржг: рзлржЯрж┐ goroutine ржЪрж╛рж▓рж┐ржпрж╝рзЗ WaitGroup ржжрж┐ржпрж╝рзЗ ржЕржкрзЗржХрзНрж╖рж╛

```go
package main

import (
    "fmt"
    "sync"
)

func main() {
    var wg sync.WaitGroup

    wg.Add(5) // рзлржЯрж╛ goroutine рж╣ржмрзЗ

    for i := 1; i <= 5; i++ {
        go func(id int) {
            defer wg.Done()
            fmt.Println("Goroutine ржЪрж▓ржЫрзЗ:", id)
        }(i)
    }

    wg.Wait() // рж╕ржм goroutine рж╢рзЗрж╖ ржирж╛ рж╣ржУржпрж╝рж╛ ржкрж░рзНржпржирзНржд ржЕржкрзЗржХрзНрж╖рж╛
    fmt.Println("рж╕ржм goroutine рж╢рзЗрж╖ рж╣ржпрж╝рзЗржЫрзЗ тЬЕ")
}
```

ЁЯзй **ржХрзА рж╣рж▓рзЛ ржПржЦрж╛ржирзЗ:**
`WaitGroup` main function ржХрзЗ ржмрзНрж▓ржХ ржХрж░рзЗ рж░рж╛ржЦржЫрзЗ ржпрждржХрзНрж╖ржг ржирж╛ рж╕ржм goroutine рж╢рзЗрж╖ рж╣рзЯред

---

## 2) Shared Data + Mutex

`Mutex`-ржПрж░ ржкрзВрж░рзНржгрж░рзВржк рж╣рж▓рзЛ тАЬ**Mutual Exclusion**тАЭ (ржкрж╛рж░рж╕рзНржкрж░рж┐ржХ ржмрж░рзНржЬржи)ред

ржПрж░ ржорзВрж▓ ржзрж╛рж░ржгрж╛ рж╣рж▓рзЛ: **ржПржХржЗ рж╕ржоржпрж╝рзЗ рж╢рзБржзрзБржорж╛рждрзНрж░ ржПржХржЯрж┐ `goroutine`-ржХрзЗ** ржПржХржЯрж┐ ржирж┐рж░рзНржжрж┐рж╖рзНржЯ ржбрзЗржЯрж╛ (shared data) ржЕрзНржпрж╛ржХрзНрж╕рзЗрж╕ ржмрж╛ ржкрж░рж┐ржмрж░рзНрждржи ржХрж░рж╛рж░ ржЕржирзБржорждрж┐ ржжрзЗржУржпрж╝рж╛ред

---

### тЪая╕П рж╕ржорж╕рзНржпрж╛: Data Race

ржпржЦржи ржПржХрж╛ржзрж┐ржХ `goroutine` ЁЯФержПржХржЗ dataЁЯФе ржПржХржпрзЛржЧрзЗ ржкрж░рж┐ржмрж░рзНрждржи ржХрж░рж╛рж░ ржЪрзЗрж╖рзНржЯрж╛ ржХрж░рзЗ, рждржЦржи **data race** ржирж╛ржоржХ ржПржХржЯрж┐ ржорж╛рж░рж╛рждрзНржоржХ ржмрж╛ржЧ рждрзИрж░рж┐ рж╣рзЯред ржПрж░ ржлрж▓рзЗ ржбрзЗржЯрж╛ ржирж╖рзНржЯ (corrupt) рж╣рзЯрзЗ ржпрзЗрждрзЗ ржкрж╛рж░рзЗ ржмрж╛ ржЕрзНржпрж╛ржкрзНрж▓рж┐ржХрзЗрж╢ржиржЯрж┐ ржХрзНрж░рзНржпрж╛рж╢ ржХрж░рждрзЗ ржкрж╛рж░рзЗред

### ЁЯФТ рж╕ржорж╛ржзрж╛ржи: `sync.Mutex`

Go-рждрзЗ ржПржЗ data race ржарзЗржХрж╛ржирзЛрж░ ржЬржирзНржп `sync` ржкрзНржпрж╛ржХрзЗржЬрзЗрж░ `Mutex` ржмрзНржпржмрж╣рж╛рж░ ржХрж░рж╛ рж╣ржпрж╝ред ржПржЯрж┐ ржПржХржЯрж┐ рждрж╛рж▓рж╛рж░ (lock) ржорждрзЛ ржХрж╛ржЬ ржХрж░рзЗред

ржПрж░ ржжрзБржЯрж┐ ржкрзНрж░ржзрж╛ржи ржорзЗржержб рж░ржпрж╝рзЗржЫрзЗ:

* **`Lock()`**: ржбрзЗржЯрж╛ ржЕрзНржпрж╛ржХрзНрж╕рзЗрж╕ ржХрж░рж╛рж░ *ржЖржЧрзЗ* ржПржЗ ржорзЗржержб ржХрж▓ ржХрж░рж╛ рж╣рзЯред
    * ржпржжрж┐ рждрж╛рж▓рж╛ржЯрж┐ ржЦрзЛрж▓рж╛ ржерж╛ржХрзЗ, рждржмрзЗ `goroutine`-ржЯрж┐ ржПржЯрж┐ рж▓ржХ ржХрж░рзЗ ржПржмржВ ржХрж╛ржЬ рж╢рзБрж░рзБ ржХрж░рзЗред
    * ржпржжрж┐ ржЕржирзНржп `goroutine` ржЖржЧрзЗржЗ рж▓ржХ ржХрж░рзЗ рж░рж╛ржЦрзЗ, рждржмрзЗ ржПржЯрж┐ рждрж╛рж▓рж╛ ржЦрзЛрж▓рж╛рж░ ржЬржирзНржп ржЕржкрзЗржХрзНрж╖рж╛ (block) ржХрж░рзЗред

* **`Unlock()`**: ржбрзЗржЯрж╛ ржкрж░рж┐ржмрж░рзНрждржи ржХрж░рж╛ *рж╢рзЗрж╖ рж╣рж▓рзЗ* ржПржЗ ржорзЗржержб ржХрж▓ ржХрж░рж╛ рж╣рзЯред
    * ржПржЯрж┐ рждрж╛рж▓рж╛ржЯрж┐ ржЦрзБрж▓рзЗ ржжрзЗржпрж╝, ржпрж╛рждрзЗ ржЕржкрзЗржХрзНрж╖рж╛рж░ржд ржЕржирзНржп `goroutine`-ржЧрзБрж▓рж┐ ржбрзЗржЯрж╛ ржЕрзНржпрж╛ржХрзНрж╕рзЗрж╕ ржХрж░рждрзЗ ржкрж╛рж░рзЗред

### ЁЯФ╕ ржЙржжрж╛рж╣рж░ржг: 1000 ржмрж╛рж░ Counter ржмрзГржжрзНржзрж┐ (Safe)

```go
package main

import (
    "fmt"
    "sync"
)

func main() {
    var counter = 0
    var mu sync.Mutex
    var wg sync.WaitGroup

    wg.Add(1000)

    for i := 0; i < 1000; i++ {
        go func() {
            defer wg.Done()
            mu.Lock()
            counter++ // ржПржЦржи ржирж┐рж░рж╛ржкржж
            mu.Unlock()
        }()
    }

    wg.Wait()
    fmt.Println("Final Counter:", counter)
}
```

ЁЯФТ ржПржЦрж╛ржирзЗ Mutex counter-ржХрзЗ ржПржХрж╕рж╛ржерзЗ ржПржХ goroutine ржжрзНржмрж╛рж░рж╛ ржкрж░рж┐ржмрж░рзНрждржи ржирж┐рж╢рзНржЪрж┐ржд ржХрж░ржЫрзЗред

---

### 3) Mutex ржмрж╛ржж ржжрж┐рж▓рзЗ ржХрзА рж╣ржпрж╝? (Race Condition!)

```go
package main

import (
    "fmt"
    "sync"
)

func main() {
    var counter = 0
    var wg sync.WaitGroup

    wg.Add(1000)

    for i := 0; i < 1000; i++ {
        go func() {
            defer wg.Done()
            counter++ // тЭМ ржмрж┐ржкржж! ржПржХрж╛ржзрж┐ржХ goroutine ржПржХрж╕рж╛ржерзЗ рж▓рж┐ржЦржЫрзЗ
        }()
    }

    wg.Wait()
    fmt.Println("Final Counter:", counter)
}
```

ЁЯТе **Output ржкрж░рж┐ржмрж░рзНрждржирж╢рзАрж▓ рж╣ржмрзЗ** тАФ ржХржЦржиржУ 800, ржХржЦржиржУ 950, ржХржЦржиржУ 1000 ржирж╛ред
ржПржЯрж╛ржЗ **Race Condition**ред

---

## 4) Race Detector ржмрзНржпржмрж╣рж╛рж░

Go-рждрзЗ ржмрж┐рж▓рзНржЯ-ржЗржи race detector ржЖржЫрзЗред

```bash
go run -race main.go
```

ржПржЯрж┐ ржмрж▓ржмрзЗ:

```
WARNING: DATA RACE
Read at ...
Previous write at ...
```

ржПрж░ ржорж╛ржирзЗ рждрзЛржорж╛рж░ ржХрзЛржбрзЗ ржПржХрж╛ржзрж┐ржХ goroutine ржПржХрж╕рж╛ржерзЗ data ржЕрзНржпрж╛ржХрзНрж╕рзЗрж╕ ржХрж░ржЫрзЗред

---

<details>
<summary> ЁЯУМ 5) RWMutex (Reader-Writer Mutex)</summary>
## ЁЯФР RWMutex (ReaderтАУWriter Mutex)

`sync.RWMutex` рж╣рж▓рзЛ ржПржоржи ржПржХржЯрж┐ рж▓ржХ ржпрж╛ **readтмЖя╕П ржмрзЗрж╢рж┐ ржУ writeтмЗя╕П ржХржо** ржХрж╛ржЬрзЗрж░ ржХрзНрж╖рзЗрждрзНрж░рзЗ ржкрж╛рж░ржлрж░ржорзНржпрж╛ржирзНрж╕ ржмрж╛рзЬрж╛рзЯред

---

### тЪЩя╕П ржХрж╛ржЬрзЗрж░ ржирж┐рзЯржо

RWMutex ржжрзБржЯрж┐ ржЖрж▓рж╛ржжрж╛ рж▓ржХ ржжрзЗрзЯ:

* **`RLock()`** тЖТ ржПржХрж╛ржзрж┐ржХ goroutine ржПржХрж╕рж╛ржерзЗ data *read* ржХрж░рждрзЗ ржкрж╛рж░рзЗ
* **`Lock()`** тЖТ рж╢рзБржзрзБржорж╛рждрзНрж░ ржПржХржЯрж┐ goroutine data *write* ржХрж░рждрзЗ ржкрж╛рж░рзЗ (рж╕ржм readers ржУ writers ржмрзНрж▓ржХ рж╣рзЯ)

---

### ЁЯУЦ ржЙржжрж╛рж╣рж░ржг

```go
var (
	value int
	mu    sync.RWMutex
)

func reader(id int, wg *sync.WaitGroup) {
	defer wg.Done()
	mu.RLock()
	fmt.Println("Reader", id, "read:", value)
	mu.RUnlock()
}

func writer(wg *sync.WaitGroup) {
	defer wg.Done()
	mu.Lock()
	value++
	fmt.Println("Writer updated value:", value)
	mu.Unlock()
}
```

ЁЯФ╣ ржПржЦрж╛ржирзЗ:

* ржПржХрж╛ржзрж┐ржХ `reader()` ржПржХржЗ рж╕ржорзЯрзЗ ржЪрж╛рж▓рждрзЗ ржкрж╛рж░рзЗ
* ржХрж┐ржирзНрждрзБ `writer()` ржЖрж╕рж▓рзЗ, ржЕржирзНржп рж╕ржмрж╛ржЗ ЁЯФе ржерзЗржорзЗ ржпрж╛рзЯ ржпрждржХрзНрж╖ржг ржирж╛ writer ржХрж╛ржЬ рж╢рзЗрж╖ ржХрж░рзЗ

---

## тЪб ржХрзЗржи RWMutex ржжрж░ржХрж╛рж░?

ржзрж░рзЛ рждрзЛржорж╛рж░ ржкрзНрж░рзЛржЧрзНрж░рж╛ржо рзпрзж% рж╕ржорзЯ рж╢рзБржзрзБ **read** ржХрж░рзЗ, ржЖрж░ рззрзж% рж╕ржорзЯ **write** ржХрж░рзЗред
ржпржжрж┐ рж╕рж╛ржзрж╛рж░ржг `Mutex` ржмрзНржпржмрж╣рж╛рж░ ржХрж░рзЛ, рждрж╛рж╣рж▓рзЗ рж╕ржм reader ржПржХрзЗ ржПржХрзЗ ржЪрж▓ржмрзЗ тАФ ржкрж╛рж░ржлрж░ржорзНржпрж╛ржирзНрж╕ ржХржорзЗ ржпрж╛ржмрзЗред

`RWMutex` ржПржЗ рж╕ржорж╕рзНржпрж╛ рж╕ржорж╛ржзрж╛ржи ржХрж░рзЗ:

* ржПржХрж╛ржзрж┐ржХ reader ржПржХрж╕рж╛ржерзЗ read ржХрж░рждрзЗ ржкрж╛рж░рзЗ (concurrent read)
* ржХрж┐ржирзНрждрзБ writer ржЖрж╕рж▓рзЗ рж╕ржмрж╛ржЗ ржмрзНрж▓ржХ рж╣ржмрзЗ ржпрждржХрзНрж╖ржг ржирж╛ writer ржХрж╛ржЬ рж╢рзЗрж╖ ржХрж░рзЗ

---

### тЪЦя╕П Mutex ржмржирж╛ржо RWMutex

| ржжрж┐ржХ                               | Mutex                 | RWMutex                 |
| --------------------------------- | --------------------- | ----------------------- |
| ржПржХрж╛ржзрж┐ржХ reader ржПржХрж╕рж╛ржерзЗ              | тЭМ ржирж╛                  | тЬЕ рж╣рзНржпрж╛ржБ                 |
| ржПржХрж╛ржзрж┐ржХ writer ржПржХрж╕рж╛ржерзЗ              | тЭМ ржирж╛                  | тЭМ ржирж╛                    |
| Read-heavy workload ржП performance | ржзрзАрж░                   | ржжрзНрж░рзБржд                   |
| ржмрзНржпржмрж╣рж╛рж░                           | Shared data ржХржо ржкрзЬрж╛ рж╣рзЯ | Shared data ржмрзЗрж╢рж┐ ржкрзЬрж╛ рж╣рзЯ |

---

### тЬЕ ржоржирзЗ рж░рж╛ржЦрзЛ

> RWMutex рждржЦржи ржмрзНржпржмрж╣рж╛рж░ ржХрж░рзЛ, ржпржЦржи **read ржЕржирзЗржХ ржмрзЗрж╢рж┐** ржЖрж░ **write ржХржо**ред
> Write ржПрж▓рзЗ рж╕ржмрж╛ржЗ ржЕржкрзЗржХрзНрж╖рж╛ ржХрж░ржмрзЗ; Read ржПрж▓рзЗ рж╕ржмрж╛ржЗ ржПржХрж╕рж╛ржерзЗ ржХрж╛ржЬ ржХрж░ржмрзЗред

</details>


### ЁЯФН Channels ржмржирж╛ржо Mutex

| ржкрж░рж┐рж╕рзНржерж┐рждрж┐                                    | ржмрзНржпржмрж╣рж╛рж░ | ржХрж╛рж░ржг                         |
| -------------------------------------------- | ------- | ---------------------------- |
| Shared variable рж░ржХрзНрж╖рж╛ ржХрж░рждрзЗ рж╣ржмрзЗ               | Mutex   | рж╕рж╣ржЬ ржУ ржХрж╛рж░рзНржпржХрж░                |
| Data goroutine-ржПрж░ ржоржзрзНржпрзЗ ржЖржжрж╛ржи-ржкрзНрж░ржжрж╛ржи ржХрж░рждрзЗ рж╣ржмрзЗ | Channel | Ownership рж╕рзНржкрж╖рзНржЯ ржУ race-free |
| Pipeline ржмрж╛ Worker-Pool ржбрж┐ржЬрж╛ржЗржи               | Channel | Natural fit                  |

---

## ЁЯзй ржЕржирзБрж╢рзАрж▓ржи

| Exercise | ржХрж╛ржЬ                                                           |
| -------- | ------------------------------------------------------------- |
| 1я╕ПтГг      | рзлржЯрж┐ goroutine ржЪрж╛рж▓рж╛ржУ ржУ WaitGroup ржжрж┐рзЯрзЗ рж╢рзЗрж╖ ржкрж░рзНржпржирзНржд ржЕржкрзЗржХрзНрж╖рж╛ ржХрж░рж╛ржУ |
| 2я╕ПтГг      | Counter 1000 ржмрж╛рж░ ржмрзГржжрзНржзрж┐ ржХрж░рзЛ Mutex ржмрзНржпржмрж╣рж╛рж░ ржХрж░рзЗ                 |
| 3я╕ПтГг      | Mutex рж╕рж░рж╛ржУ ржУ ржжрзЗржЦрзЛ ржХрзА рж╣рзЯ                                       |
| 4я╕ПтГг      | `go run -race main.go` ржжрж┐рзЯрзЗ race detector ржЪрж╛рж▓рж╛ржУ               |
| 5я╕ПтГг      | RWMutex ржжрж┐рзЯрзЗ ржПржХ Writer ржУ ржПржХрж╛ржзрж┐ржХ Reader ржЪрж╛рж▓рж╛ржУ                  |

---

## ЁЯзн рж╕рж╛рж░рж╕ржВржХрзНрж╖рзЗржк

| ржзрж╛рж░ржгрж╛                  | ржХрж╛ржЬ                                                     |
| ---------------------- | ------------------------------------------------------- |
| **WaitGroup**          | ржПржХрж╛ржзрж┐ржХ goroutine рж╢рзЗрж╖ рж╣ржУрзЯрж╛ ржкрж░рзНржпржирзНржд ржЕржкрзЗржХрзНрж╖рж╛               |
| **Mutex**              | Shared variable ржХрзЗ ржПржХрж╕ржорзЯ ржПржХ goroutine ржкрж░рж┐ржмрж░рзНрждржи ржХрж░рждрзЗ ржжрзЗрзЯ |
| **RWMutex**            | ржПржХрж╛ржзрж┐ржХ reader ржПржХржЗ рж╕рж╛ржерзЗ, ржХрж┐ржирзНрждрзБ writer ржПржХрж╛               |
| **Race Condition**     | ржПржХрж╛ржзрж┐ржХ goroutine ржПржХрж╕рж╛ржерзЗ shared data ржкрж░рж┐ржмрж░рзНрждржи ржХрж░рж▓рзЗ рж╣рзЯ    |
| **`-race` flag**       | Race Condition рж╢ржирж╛ржХрзНржд ржХрж░рж╛рж░ ржЯрзБрж▓                          |
| **Channel ржмржирж╛ржо Mutex** | Channel data pass ржХрж░рждрзЗ, Mutex data protect ржХрж░рждрзЗ         |
