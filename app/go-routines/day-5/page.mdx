# Context Cancellation, Timeout & Deadline

ржЧрждржмрж╛рж░ ржЖржорж░рж╛ `select` ржжрж┐рзЯрзЗ ржПржХрж╛ржзрж┐ржХ ржЪрзНржпрж╛ржирзЗрж▓ рж╣рзНржпрж╛ржирзНржбрзЗрж▓ ржХрж░рж╛ рж╢рж┐ржЦрзЗржЫрж┐ред ржЖржЬ ржЖржорж░рж╛ рж╢рж┐ржЦржмрзЛ `goroutine`-ржжрзЗрж░ control ржХрж░рж╛рж░ рж╕ржмржЪрзЗржпрж╝рзЗ ржЧрзБрж░рзБрждрзНржмржкрзВрж░рзНржг ржПржмржВ рж╢ржХрзНрждрж┐рж╢рж╛рж▓рзА ржЯрзБрж▓: `context`ред

-----

### ЁЯза `context` (ржХржиржЯрзЗржХрзНрж╕ржЯ) -> рж╕рж┐ржЧржирзНржпрж╛рж▓ ржкрж╛ржарж╛ржирзЛ

`context` рж╣рж▓рзЛ ржПржХржЯрж┐ ржЕржмржЬрзЗржХрзНржЯ ржпрж╛ ржПржХржЯрж┐ `goroutine`-ржХрзЗ рж╕рж┐ржЧржирзНржпрж╛рж▓ ржкрж╛ржарж╛рждрзЗ ржкрж╛рж░рзЗред ржПржЗ рж╕рж┐ржЧржирзНржпрж╛рж▓ржЧрзБрж▓рзЛ рж╣рждрзЗ ржкрж╛рж░рзЗ:

  * **ржХрзНржпрж╛ржирж╕рзЗрж▓рзЗрж╢ржи (Cancellation):** "рждрзЛржорж╛рж░ ржХрж╛ржЬ ржПржЦржи ржмржирзНржз ржХрж░рзЛред"
  * **ржЯрж╛ржЗржоржЖржЙржЯ (Timeout):** "рждрзЛржорж╛рж░ ржХрж╛ржЬ ржпржжрж┐ рзл рж╕рзЗржХрзЗржирзНржбрзЗрж░ ржоржзрзНржпрзЗ рж╢рзЗрж╖ ржирж╛ рж╣рзЯ, рждржмрзЗ ржмржирзНржз ржХрж░рзЗ ржжрж┐ржУред"
  * **ржбрзЗржбрж▓рж╛ржЗржи (Deadline):** "рждрзЛржорж╛рж░ ржХрж╛ржЬ рж░рж╛ржд рззрзз:рзлрзп ржорж┐ржирж┐ржЯрзЗрж░ ржоржзрзНржпрзЗ рж╢рзЗрж╖ ржХрж░рждрзЗ рж╣ржмрзЗ, ржирж╛ рж╣рж▓рзЗ ржмржирзНржз ржХрж░рзЗ ржжрж┐ржУред"

`Context`-ржПрж░ ржкрзНрж░ржзрж╛ржи ржХрж╛ржЬ рж╣рж▓рзЛ `goroutine`-ржжрзЗрж░ ржПржХржЯрж┐ ржирж┐рж░рзНржжрж┐рж╖рзНржЯ ржХрж╛ржЬрзЗрж░ "рж▓рж╛ржЗржлрж╕рж╛ржЗржХрзЗрж▓" ржмрж╛ ржЬрзАржмржиржХрж╛рж▓ ржмрзЗржБржзрзЗ ржжрзЗржУрзЯрж╛ред

-----

### ЁЯТз рж╕ржорж╕рзНржпрж╛: Goroutine Leak

`Context` ржмрзНржпржмрж╣рж╛рж░рзЗрж░ ржкрзНрж░ржзрж╛ржи ржХрж╛рж░ржг рж╣рж▓рзЛ **Goroutine Leak** (ржЧрзЛрж░рзБржЯрж┐ржи рж▓рж┐ржХ) ржкрзНрж░рждрж┐рж░рзЛржз ржХрж░рж╛ред

ржПржХржЯрж┐ "рж▓рж┐ржХ" рждржЦржи ржШржЯрзЗ ржпржЦржи ржЖржкржирж┐ ржПржХржЯрж┐ `goroutine` ржЪрж╛рж▓рзБ ржХрж░рзЗржи ржХрж┐ржирзНрждрзБ рж╕рзЗржЯрж┐ рж╢рзЗрж╖ ржХрж░рж╛рж░ ржХржерж╛ ржнрзБрж▓рзЗ ржпрж╛ржи (ржмрж╛ ржХрж░рждрзЗ ржкрж╛рж░рзЗржи ржирж╛)ред `goroutine`-ржЯрж┐ ржмрзНржпрж╛ржХржЧрзНрж░рж╛ржЙржирзНржбрзЗ ржЪрж▓рждрзЗржЗ ржерж╛ржХрзЗ ржПржмржВ ржорзЗржорзЛрж░рж┐ ржУ CPU ржЕржкржЪрзЯ ржХрж░рзЗред

**ржЙржжрж╛рж╣рж░ржг:** ржзрж░рзБржи ржПржХржЯрж┐ ржУрзЯрзЗржм рж╕рж╛рж░рзНржнрж╛рж░рзЗ ржПржХржЬржи ржЗржЙржЬрж╛рж░ ржПржХржЯрж┐ рж░рж┐ржХрзЛрзЯрзЗрж╕рзНржЯ ржкрж╛ржарж╛рж▓рзЛред ржЖржкржирж┐ ржПржХржЯрж┐ `goroutine` ржЪрж╛рж▓рзБ ржХрж░рж▓рзЗржи ржбрзЗржЯрж╛ржмрзЗрж╕ ржерзЗржХрзЗ рждржерзНржп ржЖржирж╛рж░ ржЬржирзНржпред ржХрж┐ржирзНрждрзБ ржЗржЙржЬрж╛рж░ рж░рж┐ржХрзЛрзЯрзЗрж╕рзНржЯржЯрж┐ ржХрзНржпрж╛ржирж╕рзЗрж▓ ржХрж░рзЗ ржжрж┐рж▓рзЛ (ржмрзНрж░рж╛ржЙржЬрж╛рж░ ржмржирзНржз ржХрж░рзЗ ржжрж┐рж▓рзЛ)ред

  * **`Context` ржЫрж╛рзЬрж╛:** ржЖржкржирж╛рж░ ржбрзЗржЯрж╛ржмрзЗрж╕ `goroutine`-ржЯрж┐ ржЪрж▓рждрзЗржЗ ржерж╛ржХржмрзЗред рж╕рзЗ ржЬрж╛ржирзЗ ржирж╛ ржпрзЗ рждрж╛рж░ ржХрж╛ржЬрзЗрж░ ржЖрж░ ржХрзЛржирзЛ ржжрж░ржХрж╛рж░ ржирзЗржЗред ржПржЯрж┐ ржПржХржЯрж┐ рж▓рж┐ржХред
  * **`Context` рж╕рж╣:** рж░рж┐ржХрзЛрзЯрзЗрж╕рзНржЯ ржХрзНржпрж╛ржирж╕рзЗрж▓ рж╣ржУрзЯрж╛рж░ рж╕рж╛ржерзЗ рж╕рж╛ржерзЗ `context` ржЖржкржирж╛рж░ `goroutine`-ржХрзЗ ржПржХржЯрж┐ "ржмржирзНржз ржХрж░рзЛ" рж╕рж┐ржЧржирзНржпрж╛рж▓ ржкрж╛ржарж╛ржмрзЗред `goroutine`-ржЯрж┐ ржХрж╛ржЬ ржмржирзНржз ржХрж░рзЗ ржжрзЗржмрзЗ ржПржмржВ рж░рж┐рж╕рзЛрж░рзНрж╕ ржорзБржХрзНржд ржХрж░ржмрзЗред

-----

### ЁЯОо `Context`-ржПрж░ ржзрж░ржг

Go-рждрзЗ `context` ржкрзНржпрж╛ржХрзЗржЬржЯрж┐ ржПржЗ рж╕рзБржмрж┐ржзрж╛ржЧрзБрж▓рзЛ ржжрзЗрзЯред

### ЁЯФ╣ 1. `context.Background()`

* ЁЯСЙ ржПржЯрж╛ рж╣рж▓рзЛ **root context**
* рж╕рж╛ржзрж╛рж░ржгржд `main` ржлрж╛ржВрж╢ржи ржмрж╛ ржПржХржЯрж┐ рж░рж┐ржХрзЛрзЯрзЗрж╕рзНржЯрзЗрж░ рж╢рзБрж░рзБрждрзЗ ржПржЯрж┐ рждрзИрж░рж┐ ржХрж░рж╛ рж╣рзЯред
* ржПржЯрж┐ ржПржХржЯрж┐ ржЦрж╛рж▓рж┐ context, ржПржЯрж╛ **ржХржЦржирзЛ cancel рж╣рзЯ ржирж╛**, ржПрж░ ржХрзЛржирзЛ ржЯрж╛ржЗржоржЖржЙржЯ ржирзЗржЗред

```go
ctx := context.Background()
```

ЁЯУШ ржПрж░ ржУржкрж░ ржнрж┐рждрзНрждрж┐ ржХрж░рзЗржЗ `WithCancel`, `WithTimeout` ржмрж╛ `WithDeadline` context рждрзИрж░рж┐ ржХрж░рж╛ рж╣рзЯред

---

#### ЁЯФ╣ 2. `context.WithCancel(parentContext)`

ржПржЯрж┐ ржПржХржЯрж┐ `parentContext` (ржпрзЗржоржи `Background()`) ржирзЗрзЯ ржПржмржВ ржжрзБржЯрж┐ ржЬрж┐ржирж┐рж╕ рж░рж┐ржЯрж╛рж░рзНржи ржХрж░рзЗ:

1.  ржПржХржЯрж┐ ржирждрзБржи **child context** (`ctx`)ред
2.  ржПржХржЯрж┐ **`cancel` ржлрж╛ржВрж╢ржи** (`cancel`)ред

ржЖржкржирж┐ ржпржЦржиржЗ `cancel()` ржлрж╛ржВрж╢ржиржЯрж┐ ржХрж▓ ржХрж░ржмрзЗржи, рждржЦржи рж╕рзЗржЗ context **ржПржмржВ рждрж╛рж░ рж╕ржм child context** cancel рж╣рзЯрзЗ ржпрж╛рзЯред

```go
ctx, cancel := context.WithCancel(context.Background())
    // `ctx` тЖТ ржорзВрж▓ context object
    // `cancel` тЖТ ржПржЗ function ржХрж▓ ржХрж░рж▓рзЗ context тАЬcancelтАЭ рж╣рзЯрзЗ ржпрж╛рзЯред

// ржПржЦрж╛ржирзЗ ржЖржорж░рж╛ ржПржХржЯрж┐ goroutine ржЪрж╛рж▓рзБ ржХрж░ржЫрж┐ ржпрж╛ рзй рж╕рзЗржХрзЗржирзНржб ржкрж░ ржкрж░рзНржпржирзНржд ржмрзНрж▓ржХ рж╣рзЯрзЗ ржерж╛ржХржмрзЗ
go func() {
    <-time.After(3 * time.Second)
    // рзй рж╕рзЗржХрзЗржирзНржб ржкрж░ ржкрж░рзНржпржирзНржд ржмрзНрж▓ржХ рж╣рзЯрзЗ ржерж╛ржХрзЛ, рждрж╛рж░ржкрж░ ржПржЧрж┐рзЯрзЗ ржпрж╛ржУ
    cancel() // cancel after 3 seconds
}()

<-ctx.Done()
fmt.Println("Context canceled:", ctx.Err())
```

ЁЯзй Output:

```
Context canceled: context canceled
```

| ржЕржВрж╢            | ржХрж╛ржЬ                                     |
| -------------- | --------------------------------------- |
| `time.After()` | ржирж┐рж░рзНржжрж┐рж╖рзНржЯ рж╕ржорзЯ ржкрж░рзЗ signal ржкрж╛ржарж╛рзЯ          |
| `cancel()`     | context cancel ржХрж░рзЗ, `Done()` ржмржирзНржз ржХрж░рзЗ   |
| `ctx.Done()`   | cancellation signal рж╢рзЛржирзЗ                |
| `ctx.Err()`    | ржХрзЗржи cancel рж╣рж▓рзЛ (Canceled / Timeout) ржмрж▓рзЗ |

#### ЁЯФ╣ 3. `context.WithTimeout(parentContext, duration)`

ЁЯСЙ ржПржЗржЯрж╛ рж╣рж▓рзЛ тАЬauto-cancelтАЭ ржХрж░рж╛ context тАФ
ржирж┐рж░рзНржжрж┐рж╖рзНржЯ рж╕ржорзЯ ржкрж░рзЗ **ржирж┐ржЬрзЗ ржерзЗржХрзЗржЗ (automatically) cancel рж╣рзЯрзЗ ржпрж╛рзЯ**ред

```go
ctx, cancel := context.WithTimeout(context.Background(), 3*time.Second)
defer cancel() // ржПржЯрж╛ main() ржлрж╛ржВрж╢ржи return ржХрж░рж╛рж░ ржарж┐ржХ ржЖржЧрзЗ рж░рж╛ржи рж╣ржмрзЗред

select {
case <-time.After(5 * time.Second):
    fmt.Println("Work finished")
case <-ctx.Done():
    fmt.Println("Timeout:", ctx.Err())
}
```

ЁЯзй Output:

```
Timeout: context deadline exceeded
```

ЁЯза ржорж╛ржирзЗ рзй рж╕рзЗржХрзЗржирзНржбрзЗрж░ ржоржзрзНржпрзЗ ржХрж╛ржЬ ржирж╛ рж╣рж▓рзЗ context ржирж┐ржЬрзЗржЗ cancel ржХрж░рзЗ ржжрзЗрзЯред

#### ЁЯФ╣ 4. `context.WithDeadline(parentContext, time)`

ЁЯСЙ `WithTimeout` ржПрж░ ржорждрзЛржЗ, ржХрж┐ржирзНрждрзБ ржирж┐рж░рзНржжрж┐рж╖рзНржЯ рж╕ржорзЯ (clock time) ржкрж░рзНржпржирзНржд wait ржХрж░рзЗред

```go
deadline := time.Now().Add(2 * time.Second)
ctx, cancel := context.WithDeadline(context.Background(), deadline)
defer cancel()
```

### ЁЯФ╣ 5. `ctx.Done()`

ЁЯСЙ `ctx.Done()` рж╣рж▓рзЛ ржПржХржЯрж╛ **channel** ржпрж╛ close рж╣рзЯрзЗ ржпрж╛рзЯ ржпржЦржи context cancel рж╣рзЯред

```go
select {
case <-ctx.Done():
    fmt.Println("ЁЯЫС Stopped:", ctx.Err())
}
```

ЁЯза ржПрж░ ржорж╛ржзрзНржпржорзЗ goroutine ржмрзБржЭрждрзЗ ржкрж╛рж░рзЗ тАФ
тАЬржЖржорж╛рж░ ржХрж╛ржЬ ржмржирзНржз ржХрж░рждрзЗ рж╣ржмрзЗредтАЭ

---

### ЁЯУб `Context` ржпрзЗржнрж╛ржмрзЗ ржХрж╛ржЬ ржХрж░рзЗ

`Context`-ржПрж░ ржжрзБржЯрж┐ ржорзВрж▓ ржЕржВрж╢: рж╕рж┐ржЧржирзНржпрж╛рж▓ ржкрж╛ржарж╛ржирзЛ ржПржмржВ рж╕рж┐ржЧржирзНржпрж╛рж▓ ржЧрзНрж░рж╣ржг ржХрж░рж╛ред

**рзз. рж╕рж┐ржЧржирзНржпрж╛рж▓ ржкрж╛ржарж╛ржирзЛ (ржХрзНржпрж╛ржирж╕рзЗрж▓ ржХрж░рж╛):**
`WithCancel`-ржПрж░ `cancel()` ржлрж╛ржВрж╢ржи ржХрж▓ ржХрж░рж╛ рж╣рж▓рзЗ, ржЕржержмрж╛ `WithTimeout`-ржПрж░ рж╕ржорзЯ рж╢рзЗрж╖ рж╣рж▓рзЗ `context` ржХрзНржпрж╛ржирж╕рзЗрж▓ рж╣рзЯрзЗ ржпрж╛рзЯред

**рзи. рж╕рж┐ржЧржирзНржпрж╛рж▓ ржЧрзНрж░рж╣ржг ржХрж░рж╛ (`ctx.Done()`):**
ржкрзНрж░рждрж┐ржЯрж┐ `context`-ржПрж░ ржПржХржЯрж┐ `.Done()` ржорзЗржержб ржЖржЫрзЗ, ржпрж╛ ржПржХржЯрж┐ **ржЪрзНржпрж╛ржирзЗрж▓** рж░рж┐ржЯрж╛рж░рзНржи ржХрж░рзЗред

  * `Context` ржпрждржХрзНрж╖ржг ржЕрзНржпрж╛ржХрзНржЯрж┐ржн ржерж╛ржХрзЗ, ржПржЗ ржЪрзНржпрж╛ржирзЗрж▓ржЯрж┐ ржмрзНрж▓ржХ ржерж╛ржХрзЗред
  * `Context` ржХрзНржпрж╛ржирж╕рзЗрж▓ рж╣ржУрзЯрж╛рж░ рж╕рж╛ржерзЗ рж╕рж╛ржерзЗ ржПржЗ ржЪрзНржпрж╛ржирзЗрж▓ржЯрж┐ **ржмржирзНржз (closed)** рж╣рзЯрзЗ ржпрж╛рзЯред

ржЖржорж░рж╛ ржЬрж╛ржирж┐, ржПржХржЯрж┐ ржмржирзНржз ржЪрзНржпрж╛ржирзЗрж▓ ржерзЗржХрзЗ рж░рж┐ржб ржХрж░рж╛ рж╣рж▓рзЗ рждрж╛ рж╕рж╛ржерзЗ рж╕рж╛ржерзЗ рж░рж┐ржЯрж╛рж░рзНржи ржХрж░рзЗред ржЖржорж░рж╛ ржПржЗ рж╕рзБржмрж┐ржзрж╛ржЯрж┐ `select`-ржПрж░ ржоржзрзНржпрзЗ ржмрзНржпржмрж╣рж╛рж░ ржХрж░рж┐:

```go
select {
case <-ctx.Done():
    // Context ржХрзНржпрж╛ржирж╕рзЗрж▓ рж╣рзЯрзЗ ржЧрзЗржЫрзЗ (ржЯрж╛ржЗржоржЖржЙржЯ ржмрж╛ ржорзНржпрж╛ржирзБрзЯрж╛рж▓)!
    // ржПржЦрж╛ржирзЗ рж╕ржм ржХрж╛ржЬ ржмржирзНржз ржХрж░рждрзЗ рж╣ржмрзЗ, рж░рж┐рж╕рзЛрж░рзНрж╕ ржкрж░рж┐рж╖рзНржХрж╛рж░ ржХрж░рждрзЗ рж╣ржмрзЗред
    fmt.Println("ржХрж╛ржЬ ржмржирзНржз ржХрж░ржЫрж┐...")
    return // goroutine ржерзЗржХрзЗ ржмрзЗрж░ рж╣рзЯрзЗ ржпрж╛ржЗ
default:
    // Context ржПржЦржирзЛ ржЕрзНржпрж╛ржХрзНржЯрж┐ржн ржЖржЫрзЗ, ржХрж╛ржЬ ржЪрж╛рж▓рж┐рзЯрзЗ ржпрж╛ржЗ
    fmt.Println("ржХрж╛ржЬ ржЪрж▓ржЫрзЗ...")
}
```

-----

### ЁЯФЧ Context Propagation (ржкрзНрж░рзЛржкрж╛ржЧрзЗрж╢ржи)

ржПржЯрж┐ `context`-ржПрж░ рж╕ржмржЪрзЗржпрж╝рзЗ ржЧрзБрж░рзБрждрзНржмржкрзВрж░рзНржг ржмрзИрж╢рж┐рж╖рзНржЯрзНржпред

> ржпржЦржи ржПржХржЯрж┐ Parent Context ржХрзНржпрж╛ржирж╕рзЗрж▓ рж╣рзЯ, рждржЦржи рждрж╛рж░ ржерзЗржХрзЗ рждрзИрж░рж┐ рж╕ржм Child Context-ржУ рж╕рзНржмрзЯржВржХрзНрж░рж┐рзЯржнрж╛ржмрзЗ ржХрзНржпрж╛ржирж╕рзЗрж▓ рж╣рзЯрзЗ ржпрж╛рзЯред

ржП ржХрж╛рж░ржгрзЗржЗ `context` рж╕ржмрж╕ржорзЯ ржлрж╛ржВрж╢ржирзЗрж░ **ржкрзНрж░ржержо ржЖрж░рзНржЧрзБржорзЗржирзНржЯ** рж╣рж┐рж╕рзЗржмрзЗ ржкрж╛рж╕ ржХрж░рж╛ рж╣рзЯ: `func myWorker(ctx context.Context, otherArg string)`ред

  * `main` ржПржХржЯрж┐ `ctx` рждрзИрж░рж┐ ржХрж░рзЗред
  * `main` ржХрж▓ ржХрж░рзЗ `funcA(ctx)`ред
  * `funcA` ржХрж▓ ржХрж░рзЗ `funcB(ctx)`ред
  * `funcB` ржХрж▓ ржХрж░рзЗ `funcC(ctx)`ред

ржпржжрж┐ `main` ржлрж╛ржВрж╢ржи `ctx`-ржХрзЗ ржХрзНржпрж╛ржирж╕рзЗрж▓ ржХрж░рзЗ (ржпрзЗржоржи, ржЗржЙржЬрж╛рж░рзЗрж░ рж░рж┐ржХрзЛрзЯрзЗрж╕рзНржЯ ржЯрж╛ржЗржоржЖржЙржЯ рж╣рж▓рзЛ), рж╕рзЗржЗ рж╕рж┐ржЧржирзНржпрж╛рж▓ржЯрж┐ `funcA`, `funcB`, ржПржмржВ `funcC`-рждрзЗ ржерж╛ржХрж╛ рж╕ржм `goroutine`-ржПрж░ ржХрж╛ржЫрзЗ ржкрзМржБржЫрзЗ ржпрж╛ржмрзЗ (`<-ctx.Done()`)ред рж╕ржмрж╛ржЗ ржПржХржпрзЛржЧрзЗ ржХрж╛ржЬ ржмржирзНржз ржХрж░рзЗ ржжрзЗржмрзЗред

-----

### ЁЯТ╗ ржЖржЬржХрзЗрж░ ржЕржирзБрж╢рзАрж▓ржи (Exercises)

ржЖрж╕рзБржи, ржЙржкрж░рзЗрж░ рж╕ржм ржзрж╛рж░ржгрж╛ ржХрзЛржб ржХрж░рзЗ ржжрзЗржЦрж┐ред

#### ржЕржирзБрж╢рзАрж▓ржи рзз ржПржмржВ рзи: `WithTimeout` (ржорзНржпрж╛ржирзБрзЯрж╛рж▓ ржХрзНржпрж╛ржирж╕рзЗрж▓ ржПржмржВ ржЯрж╛ржЗржоржЖржЙржЯ)

ржПржЗ ржЕржирзБрж╢рзАрж▓ржирзЗ ржЖржорж░рж╛ ржПржХржЯрж┐ `worker` рждрзИрж░рж┐ ржХрж░ржм ржпрж╛ ржПржХржЯрж┐ `context` ржЧрзНрж░рж╣ржг ржХрж░рзЗред ржЖржорж░рж╛ ржжрзЗржЦржм рзй рж╕рзЗржХрзЗржирзНржб ржкрж░ ржПржЯрж┐ рж╕рзНржмрзЯржВржХрзНрж░рж┐рзЯржнрж╛ржмрзЗ ржмржирзНржз рж╣рзЯрзЗ ржпрж╛рзЯред

```go
package main

import (
	"context"
	"fmt"
	"time"
)

// worker рж╣рж▓рзЛ ржПржХржЯрж┐ goroutine ржпрж╛ context рж╢рзЗрж╖ ржирж╛ рж╣ржУрзЯрж╛ ржкрж░рзНржпржирзНржд ржХрж╛ржЬ ржХрж░рзЗ
func worker(ctx context.Context, name string) {
	fmt.Printf("ЁЯС╖ %s: ржХрж╛ржЬ рж╢рзБрж░рзБ...\n", name)
	for {
		select {
		case <-ctx.Done():
			// рж╕рж┐ржЧржирзНржпрж╛рж▓ ржкрзЗрзЯрзЗржЫрж┐!
			fmt.Printf("ЁЯЫС %s: ржХрзНржпрж╛ржирж╕рзЗрж▓ рж╕рж┐ржЧржирзНржпрж╛рж▓ ржкрзЗрж▓рж╛ржо, ржХрж╛ржЬ ржмржирзНржз ржХрж░ржЫрж┐ред\n", name)
			return // goroutine ржерзЗржХрзЗ ржкрзНрж░рж╕рзНржерж╛ржи

		default:
			// Context ржарж┐ржХ ржерж╛ржХрж▓рзЗ ржХрж╛ржЬ ржЪрж╛рж▓рж┐рзЯрзЗ ржпрж╛ржЗ
			fmt.Printf("тЪЩя╕П %s: ржХрж╛ржЬ ржХрж░ржЫрж┐...\n", name)
			time.Sleep(1 * time.Second) // ржХрж╛ржЬрзЗрж░ рж╕рж┐ржорзБрж▓рзЗрж╢ржи
		}
	}
}

func main() {
	// рзз. ржПржХржЯрж┐ parent context рждрзИрж░рж┐ ржХрж░рж┐
	parentCtx := context.Background()

	// рзи. рзй рж╕рзЗржХрзЗржирзНржбрзЗрж░ ржПржХржЯрж┐ ржЯрж╛ржЗржоржЖржЙржЯ рж╕рж╣ child context рждрзИрж░рж┐ ржХрж░рж┐
	ctx, cancel := context.WithTimeout(parentCtx, 3*time.Second)
	
	// рзй. (ржЦрзБржмржЗ ржЧрзБрж░рзБрждрзНржмржкрзВрж░рзНржг) ржХрж╛ржЬ рж╢рзЗрж╖рзЗ cancel() ржХрж▓ ржХрж░рж╛
	// ржПржЯрж┐ ржирж┐рж╢рзНржЪрж┐ржд ржХрж░рзЗ ржпрзЗ context-ржПрж░ рж╕рж╛ржерзЗ ржпрзБржХрзНржд рж╕ржм рж░рж┐рж╕рзЛрж░рзНрж╕ ржорзБржХрзНржд рж╣ржмрзЗред
	// ржпржжрж┐ржУ ржЯрж╛ржЗржоржЖржЙржЯ рж╣рж▓рзЗ ржПржЯрж┐ ржирж┐ржЬрзЗ ржерзЗржХрзЗржЗ ржХрзНржпрж╛ржирж╕рзЗрж▓ рж╣ржмрзЗ, 
	// ржХрж┐ржирзНрждрзБ ржпржжрж┐ worker ржЖржЧрзЗ ржХрж╛ржЬ рж╢рзЗрж╖ ржХрж░рзЗ ржлрзЗрж▓рзЗ, рждржмрзЗ defer cancel() рж░рж┐рж╕рзЛрж░рзНрж╕ рж▓рж┐ржХ ржарзЗржХрж╛рзЯред
	defer cancel()

	fmt.Println("ЁЯЪА main: ржУрзЯрж╛рж░рзНржХрж╛рж░ ржЪрж╛рж▓рзБ ржХрж░ржЫрж┐ (рзй рж╕рзЗржХрзЗржирзНржб ржЯрж╛ржЗржоржЖржЙржЯ)...")
	go worker(ctx, "Worker-1")

	// main goroutine-ржХрзЗ рзл рж╕рзЗржХрзЗржирзНржб ржЪрж╛рж▓рзБ рж░рж╛ржЦрж┐ ржпрж╛рждрзЗ worker-ржПрж░ ржкрзНрж░рж╕рзНржерж╛ржи ржжрзЗржЦрждрзЗ ржкрж╛рж░рж┐
	time.Sleep(5 * time.Second) 
	fmt.Println("ЁЯСЛ main: ржкрзНрж░рзЛржЧрзНрж░рж╛ржо рж╢рзЗрж╖ред")
}
```

**ржЖржЙржЯржкрзБржЯ:**

```
ЁЯЪА main: ржУрзЯрж╛рж░рзНржХрж╛рж░ ржЪрж╛рж▓рзБ ржХрж░ржЫрж┐ (рзй рж╕рзЗржХрзЗржирзНржб ржЯрж╛ржЗржоржЖржЙржЯ)...
ЁЯС╖ Worker-1: ржХрж╛ржЬ рж╢рзБрж░рзБ...
тЪЩя╕П Worker-1: ржХрж╛ржЬ ржХрж░ржЫрж┐...
тЪЩя╕П Worker-1: ржХрж╛ржЬ ржХрж░ржЫрж┐...
тЪЩя╕П Worker-1: ржХрж╛ржЬ ржХрж░ржЫрж┐...
ЁЯЫС Worker-1: ржХрзНржпрж╛ржирж╕рзЗрж▓ рж╕рж┐ржЧржирзНржпрж╛рж▓ ржкрзЗрж▓рж╛ржо, ржХрж╛ржЬ ржмржирзНржз ржХрж░ржЫрж┐ред
ЁЯСЛ main: ржкрзНрж░рзЛржЧрзНрж░рж╛ржо рж╢рзЗрж╖ред
```

*ржмрж┐рж╢рзНрж▓рзЗрж╖ржг:* `Worker-1` ржарж┐ржХ рзй рж╕рзЗржХрзЗржирзНржб ржХрж╛ржЬ ржХрж░рж╛рж░ ржкрж░ `<-ctx.Done()` ржерзЗржХрзЗ рж╕рж┐ржЧржирзНржпрж╛рж▓ ржкрж╛рзЯ ржПржмржВ ржмржирзНржз рж╣рзЯрзЗ ржпрж╛рзЯред

-----

#### ржЕржирзБрж╢рзАрж▓ржи рзй, рзк ржПржмржВ рзл: Context ржЪрзЗржЗржи ржПржмржВ ржУрзЯрж╛рж░рзНржХрж╛рж░ ржХрзНржпрж╛ржирж╕рзЗрж▓рзЗрж╢ржи

ржПржЦрж╛ржирзЗ ржЖржорж░рж╛ ржжрзЗржЦржм `context` ржХрзАржнрж╛ржмрзЗ ржПржХрж╛ржзрж┐ржХ ржлрж╛ржВрж╢ржирзЗрж░ ржоржзрзНржпрзЗ (ржЪрзЗржЗржи) ржкрж╛рж╕ ржХрж░рж╛ рж╣рзЯ ржПржмржВ ржХрзНржпрж╛ржирж╕рзЗрж▓рзЗрж╢ржи ржХрзАржнрж╛ржмрзЗ ржХрж╛ржЬ ржХрж░рзЗред

```go
package main

import (
	"context"
	"fmt"
	"time"
)

// step3: ржЖрж╕рж▓ ржХрж╛ржЬ ржПржЦрж╛ржирзЗ рж╣рзЯ (ржбрзЗржЯрж╛ржмрзЗрж╕ ржХрзЛрзЯрзЗрж░рж┐ рж╕рж┐ржорзБрж▓рзЗрж╢ржи)
func step3(ctx context.Context) {
	fmt.Println("  [Step 3]: ржбрзЗржЯрж╛ржмрзЗрж╕ ржХрзЛрзЯрзЗрж░рж┐ рж╢рзБрж░рзБ... (рзи рж╕рзЗржХрзЗржирзНржб рж▓рж╛ржЧржмрзЗ)")
	select {
	case <-time.After(2 * time.Second):
		// ржХрж╛ржЬ рж╕ржорзНржкржирзНржи
		fmt.Println("  [Step 3]: ржбрзЗржЯрж╛ржмрзЗрж╕ ржХрзЛрзЯрзЗрж░рж┐ рж╕ржлрж▓ред")
	case <-ctx.Done():
		// ржХрж╛ржЬ рж╢рзЗрж╖ рж╣ржУрзЯрж╛рж░ ржЖржЧрзЗржЗ ржХрзНржпрж╛ржирж╕рзЗрж▓ рж╕рж┐ржЧржирзНржпрж╛рж▓ ржПрж▓рзЛ
		fmt.Println("  [Step 3]: ЁЯЫС ржбрзЗржЯрж╛ржмрзЗрж╕ ржХрзЛрзЯрзЗрж░рж┐ ржХрзНржпрж╛ржирж╕рзЗрж▓ржб!")
	}
}

// step2: ржбрзЗржЯрж╛ ржкрзНрж░рж╕рзЗрж╕ ржХрж░рзЗ
func step2(ctx context.Context) {
	fmt.Println(" [Step 2]: ржбрзЗржЯрж╛ ржкрзНрж░рж╕рзЗрж╕рж┐ржВ рж╢рзБрж░рзБ...")
	// ржХрж╛ржЬ ржХрж░рж╛рж░ ржЖржЧрзЗ ржЪрзЗржХ ржХрж░рж╛ (Early exit)
	if ctx.Err() != nil {
		fmt.Println(" [Step 2]: ЁЯЫС рж╢рзБрж░рзБрждрзЗржЗ ржХрзНржпрж╛ржирж╕рзЗрж▓ ржЫрж┐рж▓рзЛ, ржХрж╛ржЬ рж╢рзБрж░рзБржЗ ржХрж░рж▓рж╛ржо ржирж╛ред")
		return
	}
	
	step3(ctx) // context ржирж┐ржЪрзЗ ржкрж╛рж╕ ржХрж░рж╛
	fmt.Println(" [Step 2]: ржбрзЗржЯрж╛ ржкрзНрж░рж╕рзЗрж╕рж┐ржВ рж╢рзЗрж╖ред")
}

// step1: рж░рж┐ржХрзЛрзЯрзЗрж╕рзНржЯ рж╣рзНржпрж╛ржирзНржбрзЗрж▓ ржХрж░рзЗ
func step1(ctx context.Context) {
	fmt.Println("[Step 1]: рж░рж┐ржХрзЛрзЯрзЗрж╕рзНржЯ рж╣рзНржпрж╛ржирзНржбрзЗрж▓рж┐ржВ рж╢рзБрж░рзБ...")
	step2(ctx) // context ржирж┐ржЪрзЗ ржкрж╛рж╕ ржХрж░рж╛
	fmt.Println("[Step 1]: рж░рж┐ржХрзЛрзЯрзЗрж╕рзНржЯ рж╣рзНржпрж╛ржирзНржбрзЗрж▓рж┐ржВ рж╢рзЗрж╖ред")
}

func main() {
	// === рж╕рж┐ржирж╛рж░рж┐ржУ рзз: рж╕ржлрж▓ (ржЯрж╛ржЗржоржЖржЙржЯрзЗрж░ ржЖржЧрзЗржЗ ржХрж╛ржЬ рж╢рзЗрж╖) ===
	fmt.Println("--- рж╕рж┐ржирж╛рж░рж┐ржУ рзз: рж╕ржлрж▓ рж░рж┐ржХрзЛрзЯрзЗрж╕рзНржЯ (ржЯрж╛ржЗржоржЖржЙржЯ рзй рж╕рзЗржХрзЗржирзНржб) ---")
	ctxSuccess, cancelSuccess := context.WithTimeout(context.Background(), 3*time.Second)
	defer cancelSuccess()
	step1(ctxSuccess)

	fmt.Println("\n--- рж╕рж┐ржирж╛рж░рж┐ржУ рзи: ржХрзНржпрж╛ржирж╕рзЗрж▓ржб (ржЯрж╛ржЗржоржЖржЙржЯ рзз рж╕рзЗржХрзЗржирзНржб) ---")
	// === рж╕рж┐ржирж╛рж░рж┐ржУ рзи: ржХрзНржпрж╛ржирж╕рзЗрж▓ржб (ржЯрж╛ржЗржоржЖржЙржЯрзЗрж░ ржЖржЧрзЗржЗ рж╕рж┐ржЧржирзНржпрж╛рж▓) ===
	ctxTimeout, cancelTimeout := context.WithTimeout(context.Background(), 1*time.Second)
	defer cancelTimeout()
	step1(ctxTimeout)
	
	// ржХрзНржпрж╛ржирж╕рзЗрж▓рзЗрж╢ржирзЗрж░ ржкрзНрж░ржнрж╛ржм ржжрзЗржЦрж╛рж░ ржЬржирзНржп ржПржХржЯрзБ ржЕржкрзЗржХрзНрж╖рж╛
	time.Sleep(2 * time.Second) 
	fmt.Println("--- ржкрзНрж░рзЛржЧрзНрж░рж╛ржо рж╢рзЗрж╖ ---")
}
```

**ржЖржЙржЯржкрзБржЯ:**

```
--- рж╕рж┐ржирж╛рж░рж┐ржУ рзз: рж╕ржлрж▓ рж░рж┐ржХрзЛрзЯрзЗрж╕рзНржЯ (ржЯрж╛ржЗржоржЖржЙржЯ рзй рж╕рзЗржХрзЗржирзНржб) ---
[Step 1]: рж░рж┐ржХрзЛрзЯрзЗрж╕рзНржЯ рж╣рзНржпрж╛ржирзНржбрзЗрж▓рж┐ржВ рж╢рзБрж░рзБ...
 [Step 2]: ржбрзЗржЯрж╛ ржкрзНрж░рж╕рзЗрж╕рж┐ржВ рж╢рзБрж░рзБ...
  [Step 3]: ржбрзЗржЯрж╛ржмрзЗрж╕ ржХрзЛрзЯрзЗрж░рж┐ рж╢рзБрж░рзБ... (рзи рж╕рзЗржХрзЗржирзНржб рж▓рж╛ржЧржмрзЗ)
  [Step 3]: ржбрзЗржЯрж╛ржмрзЗрж╕ ржХрзЛрзЯрзЗрж░рж┐ рж╕ржлрж▓ред
 [Step 2]: ржбрзЗржЯрж╛ ржкрзНрж░рж╕рзЗрж╕рж┐ржВ рж╢рзЗрж╖ред
[Step 1]: рж░рж┐ржХрзЛрзЯрзЗрж╕рзНржЯ рж╣рзНржпрж╛ржирзНржбрзЗрж▓рж┐ржВ рж╢рзЗрж╖ред

--- рж╕рж┐ржирж╛рж░рж┐ржУ рзи: ржХрзНржпрж╛ржирж╕рзЗрж▓ржб (ржЯрж╛ржЗржоржЖржЙржЯ рзз рж╕рзЗржХрзЗржирзНржб) ---
[Step 1]: рж░рж┐ржХрзЛрзЯрзЗрж╕рзНржЯ рж╣рзНржпрж╛ржирзНржбрзЗрж▓рж┐ржВ рж╢рзБрж░рзБ...
 [Step 2]: ржбрзЗржЯрж╛ ржкрзНрж░рж╕рзЗрж╕рж┐ржВ рж╢рзБрж░рзБ...
  [Step 3]: ржбрзЗржЯрж╛ржмрзЗрж╕ ржХрзЛрзЯрзЗрж░рж┐ рж╢рзБрж░рзБ... (рзи рж╕рзЗржХрзЗржирзНржб рж▓рж╛ржЧржмрзЗ)
  [Step 3]: ЁЯЫС ржбрзЗржЯрж╛ржмрзЗрж╕ ржХрзЛрзЯрзЗрж░рж┐ ржХрзНржпрж╛ржирж╕рзЗрж▓ржб!
 [Step 2]: ржбрзЗржЯрж╛ ржкрзНрж░рж╕рзЗрж╕рж┐ржВ рж╢рзЗрж╖ред
[Step 1]: рж░рж┐ржХрзЛрзЯрзЗрж╕рзНржЯ рж╣рзНржпрж╛ржирзНржбрзЗрж▓рж┐ржВ рж╢рзЗрж╖ред
--- ржкрзНрж░рзЛржЧрзНрж░рж╛ржо рж╢рзЗрж╖ ---
```

*ржмрж┐рж╢рзНрж▓рзЗрж╖ржг:*

  * **рж╕рж┐ржирж╛рж░рж┐ржУ рзз:** рзй рж╕рзЗржХрзЗржирзНржбрзЗрж░ ржЯрж╛ржЗржоржЖржЙржЯ ржЫрж┐рж▓рзЛ, ржХрж┐ржирзНрждрзБ `step3`-ржПрж░ ржХрж╛ржЬ рзи рж╕рзЗржХрзЗржирзНржбрзЗ рж╢рзЗрж╖ рж╣рзЯрзЗ ржЧрзЗржЫрзЗред рждрж╛ржЗ `<-ctx.Done()` рж╕рж┐ржЧржирзНржпрж╛рж▓ ржЖрж╕рж╛рж░ ржЖржЧрзЗржЗ `<-time.After()` рж╕рж┐ржЧржирзНржпрж╛рж▓ржЯрж┐ ржЬрж┐рждрзЗржЫрзЗред
  * **рж╕рж┐ржирж╛рж░рж┐ржУ рзи:** рзз рж╕рзЗржХрзЗржирзНржбрзЗрж░ ржЯрж╛ржЗржоржЖржЙржЯ ржЫрж┐рж▓рзЛ, ржХрж┐ржирзНрждрзБ `step3`-ржПрж░ ржХрж╛ржЬ рзи рж╕рзЗржХрзЗржирзНржб рж▓рж╛ржЧрж╛рж░ ржХржерж╛ред `select` рж╕рзНржЯрзЗржЯржорзЗржирзНржЯржЯрж┐ ржжрзЗржЦрж▓рзЛ ржпрзЗ `<-ctx.Done()` (рзз рж╕рзЗржХрзЗржирзНржб) рж╕рж┐ржЧржирзНржпрж╛рж▓ржЯрж┐ `<-time.After()` (рзи рж╕рзЗржХрзЗржирзНржб) рж╕рж┐ржЧржирзНржпрж╛рж▓рзЗрж░ *ржЖржЧрзЗ* ржкрзНрж░рж╕рзНрждрзБржд рж╣рзЯрзЗржЫрзЗред рждрж╛ржЗ ржПржЯрж┐ ржХрзНржпрж╛ржирж╕рзЗрж▓рзЗрж╢ржи ржкрж╛ржержЯрж┐ ржмрзЗржЫрзЗ ржирж┐рж▓рзЛред

-----

### ЁЯЪл рж╕рж╛ржзрж╛рж░ржг ржнрзБрж▓ ржПржмржВ тЬЕ рж╕ржарж┐ржХ ржмрзНржпржмрж╣рж╛рж░

`Context` ржЦрзБржм рж╢ржХрзНрждрж┐рж╢рж╛рж▓рзА, ржХрж┐ржирзНрждрзБ ржПржЯрж┐ ржнрзБрж▓ржнрж╛ржмрзЗ ржмрзНржпржмрж╣рж╛рж░ ржХрж░рж╛ржУ ржЦрзБржм рж╕рж╣ржЬред

| рж╕рж╛ржзрж╛рж░ржг ржнрзБрж▓ (Avoid) | тЬЕ рж╕ржарж┐ржХ ржмрзНржпржмрж╣рж╛рж░ (Do) |
| :--- | :--- |
| `context` ржПржХржЯрж┐ struct-ржПрж░ ржоржзрзНржпрзЗ рж╕рзНржЯрзЛрж░ ржХрж░рж╛ред | `context`-ржХрзЗ рж╕ржмрж╕ржорзЯ ржлрж╛ржВрж╢ржирзЗрж░ **ржкрзНрж░ржержо ржЖрж░рзНржЧрзБржорзЗржирзНржЯ** рж╣рж┐рж╕рзЗржмрзЗ ржкрж╛рж╕ ржХрж░рзБржи: `func(ctx context.Context, ...)`ред |
| `context.Background()` рж╕ржм ржЬрж╛рзЯржЧрж╛рзЯ ржмрзНржпржмрж╣рж╛рж░ ржХрж░рж╛ред | `context.Background()` рж╢рзБржзрзБ `main` ржмрж╛ рж░рж┐ржХрзЛрзЯрзЗрж╕рзНржЯрзЗрж░ рж╢рзБрж░рзБрждрзЗ ржмрзНржпржмрж╣рж╛рж░ ржХрж░рзБржиред ржмрж╛ржХрж┐ рж╕ржм ржЬрж╛рзЯржЧрж╛рзЯ ржкрж╛рж╕ ржХрж░рж╛ `ctx` ржмрзНржпржмрж╣рж╛рж░ ржХрж░рзБржиред |
| `cancel()` ржлрж╛ржВрж╢ржи ржХрж▓ ржирж╛ ржХрж░рж╛ред | `defer cancel()` ржмрзНржпржмрж╣рж╛рж░ ржХрж░рзБржиред `context.With...` ржХрж▓ ржХрж░рж╛рж░ рж╕рж╛ржерзЗ рж╕рж╛ржерзЗржЗ `defer cancel()` рж▓рж┐ржЦрзЗ ржлрзЗрж▓рзБржиред ржПржЯрж┐ рж░рж┐рж╕рзЛрж░рзНрж╕ рж▓рж┐ржХ ржарзЗржХрж╛рзЯред |
| `context.TODO()` ржкрзНрж░рзЛржбрж╛ржХрж╢ржи ржХрзЛржбрзЗ рж░рзЗржЦрзЗ ржжрзЗржУрзЯрж╛ред | `TODO()` рж╢рзБржзрзБ рждржЦржиржЗ ржмрзНржпржмрж╣рж╛рж░ ржХрж░рзБржи ржпржЦржи ржЖржкржирж┐ ржирж┐рж╢рзНржЪрж┐ржд ржиржи ржХрзЛржи `context` ржмрзНржпржмрж╣рж╛рж░ ржХрж░ржмрзЗржи (ржПржмржВ ржкрж░рзЗ рждрж╛ ржарж┐ржХ ржХрж░ржмрзЗржи)ред |
| `nil` context ржкрж╛рж╕ ржХрж░рж╛ред | `nil` ржкрж╛рж╕ ржирж╛ ржХрж░рзЗ, ржпржжрж┐ ржХрзЛржирзЛ `context` ржирж╛ ржерж╛ржХрзЗ рждржмрзЗ `context.Background()` ржкрж╛рж╕ ржХрж░рзБржиред |
| `context`-ржПрж░ ржоржзрзНржпрзЗ ржбрзЗржЯрж╛ ржкрж╛рж╕ ржХрж░рж╛ (`WithValue`)ред | `WithValue` ржПрзЬрж┐рзЯрзЗ ржЪрж▓рзБржи, ржпржжрж┐ ржирж╛ рж░рж┐ржХрзЛрзЯрзЗрж╕рзНржЯ-рж╕рзНржХрзЛржкржб ржбрзЗржЯрж╛ (ржпрзЗржоржи trace ID, user ID) ржкрж╛рж╕ ржХрж░рж╛рж░ ржжрж░ржХрж╛рж░ рж╣рзЯред ржПржЯрж┐ рж╕рж┐ржЧржирзНржпрж╛рж▓рж┐ржВрзЯрзЗрж░ ржЬржирзНржп ржирзЯред |



### ЁЯФ╣ 4. `context.WithDeadline(parent, timePoint)`

ЁЯСЙ `WithTimeout` ржПрж░ ржорждрзЛржЗ, ржХрж┐ржирзНрждрзБ ржирж┐рж░рзНржжрж┐рж╖рзНржЯ рж╕ржорзЯ (clock time) ржкрж░рзНржпржирзНржд wait ржХрж░рзЗред

```go
deadline := time.Now().Add(2 * time.Second)
ctx, cancel := context.WithDeadline(context.Background(), deadline)
defer cancel()
```

---



## ЁЯзй Context Propagation ржХрзАржнрж╛ржмрзЗ ржХрж╛ржЬ ржХрж░рзЗ?

Context рж╣рж▓рзЛ **parent тЖТ child chain**.

```
Background()
   тФФтФАтФА WithCancel()
         тФФтФАтФА WithTimeout()
               тФФтФАтФА WithDeadline()
```

ржпржжрж┐ parent cancel рж╣рзЯ тЖТ рж╕ржм child context ржУ cancel рж╣рзЯред
ржПржЯрж╛ржЗ ржмрж▓рзЗ **propagation**ред

---

## тЪЩя╕П ржХрзЗржи Context ржлрж╛ржВрж╢ржирзЗрж░ **ржкрзНрж░ржержо argument** рж╣рзЯ?

ЁЯСЙ ржХрж╛рж░ржг Go design principle ржЕржирзБржпрж╛рзЯрзА context рж╣рж▓рзЛ **request-scoped metadata**ред
ржПржЯрж╛ function ржПрж░ lifecycle ржирж┐рзЯржирзНрждрзНрж░ржг ржХрж░рзЗред

тЬЕ Best Practice:

```go
func fetchData(ctx context.Context, url string) error
```

тЭМ Wrong:

```go
func fetchData(url string, ctx context.Context)
```

ЁЯза **ржХрж╛рж░ржг:** Context рж╕рж░рзНржмржжрж╛ ржЙржкрж░рзЗрж░ ржжрж┐ржХ ржерзЗржХрзЗ ржирж┐ржЪрзЗрж░ ржжрж┐ржХрзЗ propagate рж╣рзЯред

---

## ЁЯТб Context ржХрж┐ржнрж╛ржмрзЗ Goroutine Leak ржЖржЯржХрж╛рзЯ

**Goroutine leak** рж╣рзЯ ржпржЦржи goroutine cancel signal ржирж╛ ржкрзЗрзЯрзЗ ржЪрж┐рж░ржжрж┐ржи ржЕржкрзЗржХрзНрж╖рж╛ ржХрж░рзЗред

тЭМ ржЙржжрж╛рж╣рж░ржг:

```go
func worker(ch <-chan int) {
    for v := range ch {
        fmt.Println(v)
    }
}
```

ржпржжрж┐ `ch` ржХржЦржирзЛ close ржирж╛ рж╣рзЯ тЖТ goroutine ржЪрж┐рж░ржжрж┐ржи block ржерж╛ржХржмрзЗред

тЬЕ рж╕ржорж╛ржзрж╛ржи: Context ржмрзНржпржмрж╣рж╛рж░ ржХрж░рзЗ ржмржирзНржз ржХрж░рж╛ред

```go
func worker(ctx context.Context, ch <-chan int) {
    for {
        select {
        case v := <-ch:
            fmt.Println(v)
        case <-ctx.Done():
            fmt.Println("Worker stopped")
            return
        }
    }
}
```

---

## ЁЯТ╗ **Exercises**

### ЁЯзй 1я╕ПтГг Goroutine that stops when context is canceled

```go
package main

import (
    "context"
    "fmt"
    "time"
)

func main() {
    ctx, cancel := context.WithCancel(context.Background())

    go func() {
        for {
            select {
            case <-ctx.Done():
                fmt.Println("ЁЯЫС Goroutine stopped")
                return
            default:
                fmt.Println("ЁЯПГ Running...")
                time.Sleep(500 * time.Millisecond)
            }
        }
    }()

    time.Sleep(2 * time.Second)
    cancel() // stop after 2 seconds
    time.Sleep(1 * time.Second)
}
```

---

### ЁЯзй 2я╕ПтГг WithTimeout тАФ stop after 3 seconds

```go
ctx, cancel := context.WithTimeout(context.Background(), 3*time.Second)
defer cancel()

go func() {
    for {
        select {
        case <-ctx.Done():
            fmt.Println("тП░ Timeout reached:", ctx.Err())
            return
        default:
            fmt.Println("тЪЩя╕П Working...")
            time.Sleep(500 * time.Millisecond)
        }
    }
}()
time.Sleep(4 * time.Second)
```

---

### ЁЯзй 3я╕ПтГг Chain 3 Goroutines passing context downstream

```go
func worker(ctx context.Context, name string) {
    for {
        select {
        case <-ctx.Done():
            fmt.Println(name, "stopped")
            return
        default:
            fmt.Println(name, "working...")
            time.Sleep(700 * time.Millisecond)
        }
    }
}

func main() {
    ctx, cancel := context.WithTimeout(context.Background(), 3*time.Second)
    defer cancel()

    go worker(ctx, "ЁЯз▒ Worker 1")
    go worker(ctx, "ЁЯФз Worker 2")
    go worker(ctx, "тЪЩя╕П Worker 3")

    <-ctx.Done()
    fmt.Println("All workers stopped:", ctx.Err())
}
```

---

### ЁЯзй 4я╕ПтГг Cleanup with `<-ctx.Done()`

```go
select {
case <-ctx.Done():
    fmt.Println("Cleaning up resources...")
    return
}
```

---

### ЁЯзй 5я╕ПтГг Worker respecting cancellation

```go
func worker(ctx context.Context, id int) {
    for {
        select {
        case <-ctx.Done():
            fmt.Printf("Worker %d shutting down\n", id)
            return
        default:
            fmt.Printf("Worker %d doing work\n", id)
            time.Sleep(500 * time.Millisecond)
        }
    }
}

func main() {
    ctx, cancel := context.WithTimeout(context.Background(), 2*time.Second)
    defer cancel()

    for i := 1; i <= 3; i++ {
        go worker(ctx, i)
    }

    <-ctx.Done()
    fmt.Println("ЁЯЫС All workers canceled:", ctx.Err())
}
```

---

## тЪая╕П Common Mistakes & Correct Usage

| ржнрзБрж▓ ржмрзНржпржмрж╣рж╛рж░ тЭМ                    | рж╕ржарж┐ржХ ржмрзНржпржмрж╣рж╛рж░ тЬЕ                           |
| -------------------------------- | ---------------------------------------- |
| Context ржирж╛ ржкрж╛ржарж╛ржирзЛ                | рж╕ржм goroutine/fn-ржП context ржкрж╛ржарж╛ржУ          |
| Context рж╢рзЗрж╖рзЗржУ cancel() ржирж╛ ржХрж░рж╛    | рж╕ржмрж╕ржорзЯ `defer cancel()` ржмрзНржпржмрж╣рж╛рж░ ржХрж░рзЛ       |
| cancel() ржирж╛ ржбрж╛ржХрж╛                 | resource leak рж╣рждрзЗ ржкрж╛рж░рзЗ                   |
| context child chain ржирж╛ ржмрж╛ржирж╛ржирзЛ    | parent тЖТ child propagation ржмрзНржпржмрж╣рж╛рж░ ржХрж░рзЛ   |
| `context.TODO()` ржнрзБрж▓ржнрж╛ржмрзЗ ржмрзНржпржмрж╣рж╛рж░ | рж╢рзБржзрзБржорж╛рждрзНрж░ placeholder рж╣рж┐рж╕рзЗржмрзЗ ржмрзНржпржмрж╣рж╛рж░ ржХрж░рзЛ |
| `<-ctx.Done()` ignore ржХрж░рж╛        | рж╕ржм worker ржП respect ржХрж░рж╛ ржЙржЪрж┐ржд             |

---

## ЁЯз╛ **Summary (ржмрж╛ржВрж▓рж╛рзЯ рж╕рж╛рж░рж╕ржВржХрзНрж╖рзЗржк)**

| ржмрж┐рж╖рзЯ                   | ржмрж░рзНржгржирж╛                                      |
| ---------------------- | ------------------------------------------- |
| `context.Background()` | root context                                |
| `WithCancel`           | manual cancel                               |
| `WithTimeout`          | ржирж┐рж░рзНржжрж┐рж╖рзНржЯ рж╕ржорзЯ ржкрж░ auto-cancel                |
| `WithDeadline`         | ржирж┐рж░рзНржжрж┐рж╖рзНржЯ рж╕ржорзЯ ржкрж░рзНржпржирзНржд valid                 |
| `ctx.Done()`           | context cancel signal                       |
| `ctx.Err()`            | ржХрзЗржи cancel рж╣рж▓рзЛ                              |
| Context chain          | parent cancel рж╣рж▓рзЗ рж╕ржм child cancel           |
| Leak prevention        | goroutine cancel signal ржкрзЗрж▓рзЗ safely stop рж╣рзЯ |

---