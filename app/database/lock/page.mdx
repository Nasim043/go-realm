# ЁЯФТ Locking (рж▓ржХрж┐ржВ)

ржбрзЗржЯрж╛ржмрзЗрж╕рзЗ ржПржХрж╛ржзрж┐ржХ ржЗржЙржЬрж╛рж░/ржкрзНрж░рж╕рзЗрж╕ ржПржХржЗ ржбрзЗржЯрж╛ ржПржХрж╕рж╛ржерзЗ ржкрж░рж┐ржмрж░рзНрждржи ржХрж░рждрзЗ ржЪрж╛ржЗрж▓рзЗ рж╕ржВржШрж░рзНрж╖ (conflict) рж╣рждрзЗ ржкрж╛рж░рзЗред ржПржЗ concurrency рж╕ржорж╕рзНржпрж╛ рж╕рж╛ржорж▓рж╛рждрзЗ ржжрзБржЯрж┐ ржЬржиржкрзНрж░рж┐рзЯ ржХрзМрж╢рж▓ рж╣рж▓рзЛ:

* **Optimistic Locking (ржЖрж╢рж╛ржмрж╛ржжрзА рж▓ржХрж┐ржВ)**
* **Pessimistic Locking (ржирж┐рж░рж╛рж╢рж╛ржмрж╛ржжрзА рж▓ржХрж┐ржВ)**

ржирж┐ржЪрзЗ ржЙржнрзЯрзЗрж░ ржзрж╛рж░ржгрж╛, ржХрж╛ржЬрзЗрж░ ржзрж╛ржк, PostgreSQL ржЙржжрж╛рж╣рж░ржг, ржУ ржмрж╛рж╕рзНрждржм ржкрзНрж░рзЯрзЛржЧ ржжрзЗржЦрж╛ржирзЛ рж╣рж▓рзЛред

---

## ЁЯза Optimistic Locking (ржЖрж╢рж╛ржмрж╛ржжрзА рж▓ржХрж┐ржВ)

### ЁЯФН ржзрж╛рж░ржгрж╛

Optimistic Locking ржзрж░рзЗ ржирзЗрзЯ ржпрзЗ ржПржХржЗ ржбрзЗржЯрж╛рзЯ ржПржХрж╕рж╛ржерзЗ ржЖржкржбрзЗржЯрзЗрж░ рж╕ржорзНржнрж╛ржмржирж╛ **ржХржо**ред рждрж╛ржЗ рж╢рзБрж░рзБрждрзЗ ржХрзЛржирзЛ рж▓ржХ ржзрж░рж╛ рж╣рзЯ ржирж╛ тАФ ржмрж░ржВ ржЖржкржбрзЗржЯрзЗрж░ рж╕ржорзЯ ржжрзЗржЦрж╛ рж╣рзЯ ржбрзЗржЯрж╛ ржЖржЧрзЗрж░ ржорждрзЛ ржЖржЫрзЗ ржХрж┐ ржирж╛ред ржпржжрж┐ ржкрж░рж┐ржмрж░рзНрждржи рж╣рзЯрзЗ ржпрж╛рзЯ, рждрж╛рж╣рж▓рзЗ ржЖржкржбрзЗржЯ ржмрзНржпрж░рзНрже рж╣ржмрзЗ (conflict)ред

### тЪЩя╕П ржХрж╛ржЬрзЗрж░ ржзрж╛ржк

1. ржЯрзЗржмрж┐рж▓рзЗ ржПржХржЯрж┐ `version` ржмрж╛ `updated_at` ржХрж▓рж╛ржо рж░рж╛ржЦрж╛ рж╣рзЯред
2. ржбрзЗржЯрж╛ рж░рж┐ржб ржХрж░рж╛рж░ рж╕ржорзЯ рж╕рзЗржЗ `version` ржирзЛржЯ ржХрж░рж╛ рж╣рзЯред
3. ржЖржкржбрзЗржЯ ржХрж░рж╛рж░ рж╕ржорзЯ рж╢рж░рзНрждрзЗ (`WHERE id = ? AND version = ?`) ржорж┐рж▓рж┐рзЯрзЗ ржжрзЗржЦрж╛ рж╣рзЯред
4. ржпржжрж┐ ржЕржирзНржп ржХрзЗржЙ ржПрж░ ржоржзрзНржпрзЗ ржЖржкржбрзЗржЯ ржХрж░рзЗ, рждрж╛рж╣рж▓рзЗ ржХрзЛржирзЛ рж░рзЛ ржЖржкржбрзЗржЯ рж╣ржмрзЗ ржирж╛ (0 rows affected)ред

### ЁЯз╛ PostgreSQL ржЙржжрж╛рж╣рж░ржг

```sql
-- Version ржХрж▓рж╛ржо ржпрзЛржЧ
ALTER TABLE accounts ADD COLUMN version INT NOT NULL DEFAULT 0;

-- Read (ржзрж░рж╛ ржпрж╛ржХ version = N)
SELECT id, balance, version FROM accounts WHERE id = 1;

-- Update with version check
UPDATE accounts
SET balance = balance - 100,
    version  = version + 1
WHERE id = 1 AND version = N;

-- ржпржжрж┐ rows_affected = 0 тЗТ ржЕржирзНржп ржХрзЗржЙ ржЖржЧрзЗ ржЖржкржбрзЗржЯ ржХрж░рзЗржЫрзЗ
```

### тЬЕ рж╕рзБржмрж┐ржзрж╛

* ржХрзЛржирзЛ рж▓ржХ ржирж╛ ржзрж░рзЗ ржХрж╛ржЬ рж╣рзЯ тЖТ ржЙржЪрзНржЪ concurrency ржУ ржжрзНрж░рзБржд performanceред
* conflict ржХржо рж╣рж▓рзЗ ржПржЯрж┐ рж╕ржмржЪрзЗрзЯрзЗ ржХрж╛рж░рзНржпржХрж░ред

### тЪая╕П ржЕрж╕рзБржмрж┐ржзрж╛

* рж╕ржВржШрж░рзНрж╖ рж╣рж▓рзЗ рж░рж┐ржЯрзНрж░рж╛ржЗ ржмрж╛ merge logic рж▓рж╛ржЧржмрзЗред
* write-heavy рж╕рж┐рж╕рзНржЯрзЗржорзЗ ржмрж╛рж░ржмрж╛рж░ conflict рж╣рждрзЗ ржкрж╛рж░рзЗред

### ЁЯТб ржЯрж┐ржкрж╕

* PostgreSQL-ржПрж░ `xmin` рж╕рж┐рж╕рзНржЯрзЗржо ржХрж▓рж╛ржо ржжрж┐рзЯрзЗржУ version ржЯрзНрж░рзНржпрж╛ржХ ржХрж░рж╛ ржпрж╛рзЯред рждржмрзЗ рж╕рзНржкрж╖рзНржЯ `version` ржХрж▓рж╛ржо рж░рж╛ржЦрж╛ рж╕ржмржЪрзЗрзЯрзЗ рж╕рж╣ржЬред

---

## ЁЯЫбя╕П Pessimistic Locking (ржирж┐рж░рж╛рж╢рж╛ржмрж╛ржжрзА рж▓ржХрж┐ржВ)

### ЁЯФН ржзрж╛рж░ржгрж╛

ржзрж░рзЗ ржирзЗрзЯрж╛ рж╣рзЯ, ржПржХржЗ ржбрзЗржЯрж╛рзЯ ржПржХрж╕рж╛ржерзЗ ржЖржкржбрзЗржЯ рж╣ржУрзЯрж╛рж░ рж╕ржорзНржнрж╛ржмржирж╛ **ржмрзЗрж╢рж┐**ред рждрж╛ржЗ ржбрзЗржЯрж╛ рж░рж┐ржб ржХрж░рж╛рж░ рж╕ржорзЯржЗ рж▓ржХ ржзрж░рж╛ рж╣рзЯ, ржпрж╛рждрзЗ ржЕржирзНржп ржХрзЗржЙ ржЖржкржбрзЗржЯ ржирж╛ ржХрж░рждрзЗ ржкрж╛рж░рзЗред

### тЪЩя╕П ржХрж╛ржЬрзЗрж░ ржзрж╛ржк

1. ржЯрзНрж░рж╛ржирзНрж╕рзНржпрж╛ржХрж╢ржи рж╢рзБрж░рзБ рж╣рзЯред
2. SELECT ржХрж░рж╛рж░ рж╕ржорзЯ `FOR UPDATE` ржмрзНржпржмрж╣рж╛рж░ ржХрж░рж╛ рж╣рзЯред
3. ржЯрзНрж░рж╛ржирзНрж╕рзНржпрж╛ржХрж╢ржи рж╢рзЗрж╖ ржирж╛ рж╣ржУрзЯрж╛ ржкрж░рзНржпржирзНржд ржЕржирзНржп writer/readers ржЕржкрзЗржХрзНрж╖рж╛ ржХрж░ржмрзЗред

### ЁЯз╛ PostgreSQL ржЙржжрж╛рж╣рж░ржг

```sql
BEGIN;

-- ржЯрж╛рж░рзНржЧрзЗржЯ рж░рзЗржХрж░рзНржб рж▓ржХ
SELECT * FROM accounts WHERE id = 1 FOR UPDATE;

-- ржирж┐рж░рж╛ржкржжрзЗ ржЖржкржбрзЗржЯ
UPDATE accounts SET balance = balance + 100 WHERE id = 1;

COMMIT;
```

#### рждрж╛рзОржХрзНрж╖ржгрж┐ржХ ржмрзНржпрж░рзНржерждрж╛ (wait ржирж╛ ржХрж░рзЗ)

```sql
SELECT * FROM accounts WHERE id = 1 FOR UPDATE NOWAIT; -- рж▓ржХ ржерж╛ржХрж▓рзЗ error ржжрзЗрзЯ
```

#### Queue ржмрж╛ Worker pattern-ржП

```sql
SELECT id
FROM jobs
WHERE status = 'pending'
FOR UPDATE SKIP LOCKED
LIMIT 10;
```

### тЬЕ рж╕рзБржмрж┐ржзрж╛

* Lost update ржмрж╛ dirty write ржкрзНрж░рждрж┐рж░рзЛржз рж╣рзЯред
* ржХрзНрж░рж┐ржЯрж┐ржХрзНржпрж╛рж▓ ржбрзЗржЯрж╛ ржкрж░рж┐ржмрж░рзНрждржирзЗрж░ ржХрзНрж╖рзЗрждрзНрж░рзЗ ржирж┐рж░рж╛ржкржжред

### тЪая╕П ржЕрж╕рзБржмрж┐ржзрж╛

* ржмрзНрж▓ржХрж┐ржВ ржУ ржбрзЗржбрж▓ржХ ржЭрзБржБржХрж┐ред
* ржжрзАрж░рзНржШ ржЯрзНрж░рж╛ржирзНрж╕рзНржпрж╛ржХрж╢ржи рж░рж╛ржЦрж▓рзЗ ржкрж╛рж░ржлрж░ржорзНржпрж╛ржирзНрж╕ ржХржорзЗ ржпрж╛рзЯред

---

## тЪЦя╕П рждрзБрж▓ржирж╛ржорзВрж▓ржХ рж╕рж╛рж░рж╛ржВрж╢

| ржжрж┐ржХ             | Optimistic Locking        | Pessimistic Locking              |
| --------------- | ------------------------- | -------------------------------- |
| ржзрж╛рж░ржгрж╛           | рж╕ржВржШрж░рзНрж╖ рж╣ржмрзЗ ржирж╛ ржзрж░рзЗ ржирзЗрзЯ     | рж╕ржВржШрж░рзНрж╖ ржкрзНрж░рж╛рзЯржЗ рж╣ржмрзЗ ржзрж░рзЗ ржирзЗрзЯ        |
| рж▓ржХ рж╕ржорзЯ          | ржЖржкржбрзЗржЯрзЗрж░ рж╕ржорзЯ ржЪрзЗржХ ржХрж░рзЗ       | рж░рж┐ржбрзЗрж░ рж╕ржорзЯрзЗржЗ рж▓ржХ ржзрж░рзЗ               |
| ржкрж╛рж░ржлрж░ржорзНржпрж╛ржирзНрж╕    | ржжрзНрж░рзБржд, ржмрзЗрж╢рж┐ concurrent    | ржзрзАрж░, ржХржо concurrent               |
| ржЭрзБржБржХрж┐           | conflict рж╣рж▓рзЗ retry ржжрж░ржХрж╛рж░  | deadlock/bloc рж╣рждрзЗ ржкрж╛рж░рзЗ           |
| ржмрзНржпржмрж╣рж╛рж░ ржХрзНрж╖рзЗрждрзНрж░ | рж╕рж╛ржзрж╛рж░ржг CRUD, ржХржо ржХржиржлрзНрж▓рж┐ржХрзНржЯ | ржмрзНржпрж╛ржВржХрж┐ржВ, ржмрзБржХрж┐ржВ, critical update |

---

## ЁЯзй ржХржЦржи ржХрзЛржиржЯрж╛ ржмрзНржпржмрж╣рж╛рж░ ржХрж░ржмрзЗржи

| ржкрж░рж┐рж╕рзНржерж┐рждрж┐                                                      | ржкрзНрж░рж╕рзНрждрж╛ржмрж┐ржд ржкржжрзНржзрждрж┐ |
| -------------------------------------------------------------- | ----------------- |
| Read-heavy API (ржХржо ржХржиржлрзНрж▓рж┐ржХрзНржЯ)                                  | Optimistic        |
| Stock decrement, Money transfer, Admission bed allocation      | Pessimistic       |
| Multiple concurrent form edits                                 | Optimistic        |
| Critical transactional consistency (Finance, Pharmacy billing) | Pessimistic       |

---

## ЁЯПБ ржЙржкрж╕ржВрж╣рж╛рж░

* **Optimistic Locking** тЖТ рж╣рж╛рж▓ржХрж╛ ржХржиржлрзНрж▓рж┐ржХрзНржЯрзЗ ржжрзНрж░рзБржд ржУ рж╕рзНржХрзЗрж▓рзЗржмрж▓ред
* **Pessimistic Locking** тЖТ ржбрзЗржЯрж╛ ржЗржирзНржЯрж┐ржЧрзНрж░рж┐ржЯрж┐ ржпрзЗржЦрж╛ржирзЗ рж╕ржмржЪрзЗрзЯрзЗ ржЧрзБрж░рзБрждрзНржмржкрзВрж░рзНржгред
* PostgreSQL ржЙржнрзЯ ржХрзМрж╢рж▓ржЗ рж╢ржХрзНрждржнрж╛ржмрзЗ рж╕рж╛ржкрзЛрж░рзНржЯ ржХрж░рзЗред рж╕рж┐рж╕рзНржЯрзЗржорзЗрж░ ржкрзНрж░ржХрзГрждрж┐ ржЕржирзБржпрж╛рзЯрзА ржмрзЗржЫрзЗ ржирж┐ржи тАФ performance ржирж╛ consistency, ржХрзЛржиржЯрж╛ ржмрзЗрж╢рж┐ ржЧрзБрж░рзБрждрзНржмржкрзВрж░рзНржг рждрж╛ ржмрж┐ржмрзЗржЪржирж╛ ржХрж░рзБржиред
